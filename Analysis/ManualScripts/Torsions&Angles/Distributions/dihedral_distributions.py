import os

nlip = 128
offset = 134

#  change indices/torsion names here if needed
torsions = {
    ## OpenFF (see original 2.2.0 SMILES string)
    # 'P1_O1_C2_H2': [15364, 15363, 15362, 15414], # phosphate torsions
    # 'P1_O4_C3_H4': [15364, 15367, 15368, 15416],
    # 'C2_O1_P1_O4': [15362, 15363, 15364, 15367],
    # 'C2_O1_P1_O3': [15362, 15363, 15364, 15366],
    # 'C1_C2_O1_P1': [15361, 15362, 15363, 15364],
    # 'C2_O1_P1_O2': [15362, 15363, 15364, 15365],
    # 'P1_O1_C2_H3': [15364, 15363, 15362, 15415],
    # 'P1_O4_C3_C4': [15364, 15367, 15368, 15369],
    # 'P1_O4_C3_H5': [15364, 15367, 15368, 15417],
    #
    # 'DB':       [15383, 15384, 15385, 15386], # sn-2 carbon torsions (+adjacent compensatory torsions), nitrogen headgroup, and glycerol backbone
    # 'DB_HH':    [15443, 15384, 15385, 15444],
    # 'DB_HC':    [15443, 15384, 15385, 15386],
    # '2-5_HH':   [15429, 15377, 15378, 15431],
    # '2-5_HC':   [15429, 15377, 15378, 15379],
    # '2-5_sn2':  [15377, 15378, 15379, 15380],
    # '15-18_sn2':[15390, 15391, 15392, 15393],
    # 'NHG':      [15370, 15369, 15368, 15367],
    # 'GB':       [15362, 15361, 15395, 15396],
    #
    '27_28_29_30': [15397, 15398, 15399, 15400], # sn1 isomerization test (OpenFF SMILES string specific)
    '28_29_30_31': [15398, 15399, 15400, 15401],
    '29_30_31_32': [15399, 15400, 15401, 15402],
    '30_31_32_33': [15400, 15401, 15402, 15403],
    '31_32_33_34': [15401, 15402, 15403, 15404],
    '32_33_34_35': [15402, 15403, 15404, 15405],
    '33_34_35_36': [15403, 15404, 15405, 15406],
    '34_35_36_37': [15404, 15405, 15406, 15407],
    '35_36_37_38': [15405, 15406, 15407, 15408],
    '36_37_38_39': [15406, 15407, 15408, 15409],
    '37_38_39_40': [15407, 15408, 15409, 15410],
    '38_39_40_41': [15408, 15409, 15410, 15411],
    '39_40_41_42': [15409, 15410, 15411, 15412],
    ## Lipid21
    # 'P1_O1_C2_H2': [59, 58, 55, 56],
    # 'P1_O4_C3_H4': [59, 60, 61, 62],
    # 'C2_O1_P1_O4': [55, 58, 59, 60],
    # 'C2_O1_P1_O3': [55, 58, 59, 80],
    # 'C1_C2_O1_P1': [53, 55, 58, 59],
    # 'C2_O1_P1_O2': [55, 58, 59, 81],
    # 'P1_O1_C2_H3': [59, 58, 55, 57],
    # 'P1_O4_C3_C4': [59, 60, 61, 64],
    # 'P1_O4_C3_H5': [59, 60, 61, 63],
    #
    # 'DB':       [103, 106, 108, 110],
    # 'DB_HH':    [107, 106, 108, 109],
    # 'DB_HC':    [107, 106, 108, 110],
    # '2-5_HH':   [86, 85, 88, 89],
    # '2-5_HC':   [86, 85, 88, 89],
    # '2-5_sn2':  [85, 88, 91, 94],
    # '15-18_sn2':[122, 125, 128, 131],
    # 'NHG':      [67, 64, 61, 60],
    # 'GB':       [55, 53, 50, 49],
    ## CHARMM36
    # 'P1_O1_C2_H2': [20, 24, 25, 26],
    # 'P1_O4_C3_H4': [20, 23, 17, 18],
    # 'C2_O1_P1_O4': [25, 24, 20, 23],
    # 'C2_O1_P1_O3': [25, 24, 20, 21],
    # 'C1_C2_O1_P1': [28, 25, 24, 20],
    # 'C2_O1_P1_O2': [25, 24, 20, 22],
    # 'P1_O1_C2_H3': [20, 24, 25, 27],
    # 'P1_O4_C3_C4': [20, 23, 17, 2],
    # 'P1_O4_C3_H5': [20, 23, 17, 19],
    #
    # 'DB':       [60, 63, 65, 67],
    # 'DB_HH':    [64, 63, 65, 66],
    # 'DB_HC':    [64, 63, 65, 67],
    # '2-5_HH':   [34, 33, 45, 46],
    # '2-5_HC':   [34, 33, 45, 48],
    # '2-5_sn2':  [33, 45, 48, 51],
    # '15-18_sn2':[79, 82, 85, 88],
    # 'NHG':      [ 1,  2, 17, 23],
    # 'GB':       [25, 28, 36, 39],
}

os.makedirs('index_files', exist_ok=True)
os.makedirs('xvg_files', exist_ok=True)

for name, atoms in torsions.items():
    fname = os.path.join('index_files', name + ".ndx")
    label = "[ " + name + " ]"

    with open(fname, "w") as pfile:
        print(label, file=pfile)
        for n in range(nlip):
            print(f"{atoms[0] + offset * n:4d} {atoms[1] + offset * n:4d} {atoms[2] + offset * n:4d} {atoms[3] + offset * n:4d}", file=pfile)

# "_OFF" is the default xvg suffix I have here. Change if needed
    xvg_name = f"xvg_files/{name}_OFF.xvg"
    gmx_command = f"gmx angle -f analysis.xtc -n {fname} -od {xvg_name} -type dihedral"
    os.system(gmx_command)
